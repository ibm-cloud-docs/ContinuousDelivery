---

copyright:
  years: 2023
lastupdated: "2023-04-18"

keywords:

subcollection: ContinuousDelivery

---

{{site.data.keyword.attribute-definition-list}}

# Enabling event notifications for toolchains
{: #event-notifications-cd}

As an administrator of toolchains, you might want to send notifications of events in a toolchain or a tool integration to other users, or human destinations, by using email, SMS, or other supported delivery channels. Also, you might want to send these notifications of events to other applications to build logic by using event-driven programming using webhooks, for example. This approach is made possible by the integration between toolchains and {{site.data.keyword.en_full}}.
{: shortdesc}

To send information to {{site.data.keyword.en_short}}, you must add an {{site.data.keyword.en_short}} tool integration to your toolchain. For more information about working with {{site.data.keyword.en_short}}, see [Getting started with {{site.data.keyword.en_short}}](/docs/event-notifications?topic=event-notifications-getting-started).

## How events are collected and sent by toolchains
{: #event-notifications-how-cd}

When an event of interest takes place in a toolchain or one of the supported tool integrations, the toolchain communicates with a connected {{site.data.keyword.en_short}} instance to forward a notification to a [supported destination](/docs/event-notifications?topic=event-notifications-en-destination).

## Events for {{site.data.keyword.contdelivery_short}}
{: #event-notifications-list-cd}

The following table lists the toolchain events.

| Event Name | Event Type | Subtype | Description |
|:-----------|:----------------|:-----------------------|:--------------|
| `Tool created` | `com.ibm.cloud.toolchain.toolchain` | `toolchain_bind:1`         | This event is sent when a tool integration is created and added to a toolchain. |
| `Tool deleted` | `com.ibm.cloud.toolchain.toolchain` | `toolchain_bind:1` | This event is sent when a tool integration is deleted and removed from a toolchain. |
| `Pipeline run started` | `com.ibm.cloud.toolchain.pipeline` | `pipeline_start:1` | This event is sent when either a Tekton pipeline run or a Classic pipeline stage starts. |
| `Pipeline run succeeded` | `com.ibm.cloud.toolchain.pipeline` | `pipeline_success:1`  | This event is sent when either a Tekton pipeline run or a Classic pipeline stage completes successfully. |
| `Pipeline run failed` | `com.ibm.cloud.toolchain.pipeline` | `pipeline_fail:1` | This event is sent when either a Tekton pipeline run or a Classic pipeline stage completes with an error or a failure. | 
| `Pipeline run cancelled` | `com.ibm.cloud.toolchain.pipeline` | `pipeline_cancel:1` | This event is sent when either a Tekton pipeline run or a Classic pipeline is cancelled. | 
{: caption="Table 1. Actions that generate event notifications" caption-side="bottom"}

## Enabling notifications
{: #event-notifications-enable-cd}

Events that are generated by a toolchain or an associated tool integration can be forwarded to an {{site.data.keyword.en_short}} service instance that is available in the same account. Although you can configure each toolchain to send messages to only one {{site.data.keyword.en_short}} service instance, one instance of {{site.data.keyword.en_short}} can receive events from multiple toolchains.

### Connecting to {{site.data.keyword.en_short}} in the console
{: #event-notifications-enable-uicd}
{: ui}

You can add the {{site.data.keyword.en_short}} tool integration to your toolchain by using the console.

1. From the {{site.data.keyword.cloud_notm}} console, click the menu icon ![hamburger icon](images/icon_hamburger.svg), and select **DevOps**.
1. On the Toolchains page, click a toolchain to open its Overview page. Alternatively, on the App details page in your app, click the toolchain name.
1. To view a list of tool integrations to add, click **Add**.
1. Click the {{site.data.keyword.en_short}} tool integration.
1. Enter a name for the {{site.data.keyword.en_short}} tool instance.
1. Select the {{site.data.keyword.en_short}} instance to connect the toolchain to.
1. Click **Create Integration** to add the {{site.data.keyword.en_short}} tool integration to your toolchain.

### Connecting to {{site.data.keyword.en_short}} with the API
{: #event-notifications-enable-apicd}
{: api}

You can add the {{site.data.keyword.en_short}} tool integration to your toolchain by using the API.

1. [Obtain an IAM bearer token](https://{DomainName}/apidocs/toolchain#authentication){: external}. Alternatively, if you are using an SDK, [obtain an IAM API key](https://{DomainName}/iam/apikeys){: external} and set the client options by using environment variables.
   
   ```bash
   export CD_TOOLCHAIN_AUTH_TYPE=iam && \
   export CD_TOOLCHAIN_APIKEY={iam_api_key} && \
   export CD_TOOLCHAIN_URL={base_url}
   ```
   {: pre}

1. [Look up the ID of the toolchain](https://{DomainName}/apidocs/toolchain#list-toolchains){: external} in which you want to create your tool integration.
1. Specify `eventnotifications` as the `tool_type_id`.
1. Specify the following `tool_parameters` that are required by the tool integration:

   *  `name`: The name that is used to identify the {{site.data.keyword.en_short}} tool integration.
   *  `instance-crn`: The Cloud Resource Name (CRN) of the {{site.data.keyword.en_short}} service instance.

1. Add the tool integration within the targeted toolchain.
   
   ```curl
   curl -X POST --location --header "Authorization: Bearer {iam_token}" \
     --header "Accept: application/json" \
     --header "Content-Type: application/json" \
     --data '{ "name": "{tool_name}", "tool_type_id": "{tool_type_id}", "parameters": {tool_parameters} }' \
     "{base_url}/toolchains/{toolchain_id}/tools"
   ```
   {: pre}
   {: curl}

   ```javascript
   const CdToolchainV2 = require('@ibm-cloud/continuous-delivery/cd-toolchain/v2');
   const toolchainService = CdToolchainV2.newInstance();
   ...
   (async() => {
      const toolPrototypeModel = {
         toolchainId: {toolchain_id},
         toolTypeId: {tool_type_id},
         name: {tool_name},
         parameters: {tool_parameters}
      };
      const response = await toolchainService.createTool(toolPrototypeModel);
   })();

   ```
   {: codeblock}
   {: node}

   ```go
   import (
	   "github.com/IBM/continuous-delivery-go-sdk/cdtoolchainv2"
   )
   ...
   toolchainClientOptions := &cdtoolchainv2.CdToolchainV2Options{}
   toolchainClient, err := cdtoolchainv2.NewCdToolchainV2UsingExternalConfig(toolchainClientOptions)
   createToolOptions := toolchainClient.NewCreateToolOptions({toolchain_id}, {tool_type_id})
   createToolOptions.SetName({tool_name})
   createToolOptions.SetParameters({tool_parameters})
   tool, response, err := toolchainClient.CreateTool(createToolOptions)
   ```
   {: codeblock}
   {: go}

   ```python
   from ibm_continuous_delivery.cd_toolchain_v2 import CdToolchainV2
   ...
   toolchain_service = CdToolchainV2.new_instance()
   tool = toolchain_service.create_tool(
      name = {tool_name},
      toolchain_id = {toolchain_id},
      tool_type_id = {tool_type_id},
      parameters = {tool_parameters}
   )
   ```
   {: codeblock}
   {: python}

   ```java
   import com.ibm.cloud.continuous_delivery.cd_toolchain.v2.CdToolchain;
   import com.ibm.cloud.continuous_delivery.cd_toolchain.v2.model.*;
   ...
   CdToolchain toolchainService = CdToolchain.newInstance();
   CreateToolOptions createToolOptions = new CreateToolOptions.Builder()
      .name({tool_name})
      .parameters({tool_parameters})
      .toolchainId({toolchain_id})
      .toolTypeId({tool_type_id})
      .build();
   Response<ToolchainToolPost> response = toolchainService.createTool(createToolOptions).execute();
   ToolchainToolPost tool = response.getResult();
   ```
   {: codeblock}
   {: java}

The following table lists and describes each of the variables that are used in the previous steps.   
    
| Variable | Description |
|:---------|:------------|
| `{base_url}` | The Toolchain API endpoint URL. For more information about supported values, see [Endpoint URL](https://{DomainName}/apidocs/toolchain#endpoint-url){: external}. |
| `{iam_api_key}` | Your IAM API key. |
| `{iam_token}` | A valid IAM bearer token. |
| `{tool_name}` | The name of the tool integration. |
| `{tool_parameters}` | Unique key-value pairs that represent the parameters to use to create the tool integration. For more information about the supported parameters for each tool integration, see [Tool integrations](/docs/ContinuousDelivery?topic=ContinuousDelivery-integrations&interface=api#tool_integrations). |
| `{tool_type_id}` | The unique, short name that represents the type of the tool integration. For a list of supported values, see [Tool integrations](ContinuousDelivery-integrations&interface=api#tool_integrations). |
| `{toolchain_id}` | The toolchain in which to create the tool integration. |
{: caption="Table 2. Variables for provisioning the tool integration with the API" caption-side="top"}

### Adding a tool integration with Terraform
{: #event-notifications-enable-terraformcd}
{: terraform}

You can add the {{site.data.keyword.en_short}} tool integration to your toolchain by using Terraform.

1. To install the Terraform command-line interface (CLI) and configure the {{site.data.keyword.cloud_notm}} provider plug-in for Terraform, follow the tutorial for [Getting started with Terraform on {{site.data.keyword.cloud}}](/docs/ibm-cloud-provider-for-terraform?topic=ibm-cloud-provider-for-terraform-getting-started).
1. Create a Terraform configuration file that is named `main.tf`. In this file, add the configuration to create resource instances by using the HashiCorp Configuration Language (HCL). For more information about using this configuration language, see the [Terraform documentation](https://www.terraform.io/docs/language/index.html){: external}.

   The following example creates a {{site.data.keyword.deliverypipeline}} tool integration by using the `ibm_cd_toolchain_tool_pipeline` resource, where `toolchain_id` is a GUID that represents the toolchain in which to create the tool integration. 
   
   ```terraform
   data "ibm_cd_toolchain" "cd_toolchain" {
     toolchain_id = {toolchain_id}
   }
   
   resource "ibm_cd_toolchain_tool_eventnotifications" "en_instance" {
     toolchain_id = data.ibm_cd_toolchain.cd_toolchain.id
     parameters {
       name = "myEventNotificationsInstance"
       instance_crn = "myCrn"
     }
   }
   ```
   {: codeblock}

   For more information about tool integration resources, see the full list of supported tool integration resources in the [{{site.data.keyword.cloud_notm}} Terraform Registry](https://registry.terraform.io/providers/IBM-Cloud/ibm/latest/docs/resources/cd_toolchain){: external}.

1. Initialize the Terraform CLI.

   ```terraform
   terraform init
   ```
   {: pre}
   
1. Create a Terraform execution plan. This plan summarizes the actions that must run to create the tool integration.

   ```terraform
   terraform plan
   ```
   {: pre}

1. Apply the Terraform execution plan. Terraform takes the required actions to create the tool integration.

   ```terraform
   terraform apply
   ```
   {: pre}


## Delivering notifications to select destinations
{: #event-notifications-destinations-cd}

After you enable event notifications for a toolchain, create [topics](/docs/event-notifications?topic=event-notifications-en-create-en-topic), [destinations](/docs/event-notifications?topic=event-notifications-en-create-en-destination), and [subscriptions](/docs/event-notifications?topic=event-notifications-en-create-en-subscription) in {{site.data.keyword.en_short}} so that alerts can be forwarded and delivered to your selected destinations.

For a complete list of supported destinations, see the [{{site.data.keyword.en_short}} documentation](/docs/event-notifications?topic=event-notifications-en-destination).
{: tip}

## Notification payload details
{: #event-notifications-payload}

Events that are generated by toolchains and their associated tool integrations instances contain various fields that help you to identify the source and details of an event.

Event notifications from toolchains and tool integration instances contain only metadata properties, such as names or identifiers of resources. Sensitive data, such as API keys or passwords, is not included in generated events.
{: tip}

The properties that are sent to {{site.data.keyword.en_short}} vary depending on the event type. For example, if a `com.ibm.cloud.toolchain.pipeline:pipeline_start:1` event takes place, the toolchain sends a notification payload to {{site.data.keyword.en_short}} that is similar to the following example.

```json
{
   "subject": {
      "name": "<user>",
      "email": "<user_email>",
      "iam_id": "<iam_id>"
   }.
   "toolchain.instance": {
      "crn": "crn:v1:bluemix:public:toolchain:<region>:a/<account_id>:<toolchain_id>::",
      "href": "https://api.<region>.devops.cloud.ibm.com/toolchain/v2/toolchains/<toolchain_id>",
      "id": "357d4432-964a-46ae-83d4-df91eb539d1a",
      "name": "EventNotifications-toolchain",
      "resource_group_id": "<resource_group_id>",
      "ui_href": "https://console.cloud.ibm.com/devops/toolchains/<toolchain_id>?env_id=ibm:ys1:us-south"
   },
   "toolchain.tool-instance": {
      "href": "https://api.<region>.devops.cloud.ibm.com/toolchain/v2/toolchains/<toolchain_id>/tools/<pipeline_id>",
      "id": "<pipeline_id>",
      "name": "ci-pipeline",
      "tool_type_id": "pipeline",
      "referent": {
         "ui_href": "https://console.cloud.ibm.com/devops/pipelines/<pipeline_id>?env_id=ibm:ys1:us-south"
      }
   },
   "toolchain.pipeline-run": {
      "id": "<run_id>",
      "run_number": 11,
      "start_time": "2023-04-17T16:48:36.928Z",
      "ui_href": "https://console.cloud.ibm.com/devops/pipelines/<pipeline_id>/<stage_id>/<run_id>?env_id=<region_id>"
   }
}
```
{: screen}

The following table provides detailed information about each event notification property.

| Property | Description |
| ---- | ---- |
| `subject` | Optional. The object that represents the subject that initiated the event. This object might contain the following fields: `name`: The name of the subject, `email`: The email of the subject, and `iam_id`: The IAM ID of the subject. |
| `toolchain.instance` | The object that represents the toolchain where the event originated. This object contains the following fields: `crn`: The CRN of the toolchain, `id`: The ID of the toolchain, `resource_group_id`: The ID of the toolchain's resource group, `name`: The name of the toolchain, `href`: The API endpoint for the toolchain, and `ui_href`: The UI endpoint for the toolchain. |
| `toolchain.tool-instance` | The object that represents the toolchain instance that participates in the event. For the `toolchain_bind` and `toolchain_unbind` subtypes, this object is the tool integration instance that is being bound or unbound. For pipeline events, this object is the pipeline tool integration instance where the event originated. This object contains the following fields: `id`: The ID of the tool integration instance, `tool_type_id`: The ID of the [tool type](/docs/ContinuousDelivery?topic=ContinuousDelivery-integrations&interface=api#tool_integrations), `href`: The API endpoint for the tool integration instance, `state`: The state of the tool integration instance, `referent`: An object that contains information about the tool integration that is represented by the tool integration instance, and `ui_href`: The UI end point for the tool integration that is represented by the tool integration instance. It might also contain the following optional fields: `name`: The name of the tool integration instance. | 
| `toolchain.pipeline-run` | The object that represents the Tekton pipeline run or Classic pipeline stage run where the event originated. This object is applicable only to pipeline events and contains the following fields: `id`: The ID of the Tekton pipeline run or Classic pipeline stage and `ui_href`: The UI endpoint of the Tekton pipeline run or Classic pipeline stage. It might also contain the following optional fields: `run_number`: The run number of the Tekton pipeline run or the Classic pipeline stage, `start_time`: The time that the run started, in ISO 8601 format, `finish_time`: The time that the run finished, in ISO 8601 format, and  `duration`: The duration of the run, in ISO 8601 format.|
{: caption="Table 3. Properties in an event notification payload" caption-side="bottom"}
